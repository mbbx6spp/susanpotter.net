<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#123652"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Susan Potter">
    <meta name="description" content="/">
    <meta name="keywords" content="Distributed Systems, Functional Programming, Systems Architecture, Software Development, Software Engineering Leadership, Technical Strategy">

    <meta property="og:site_name" content="Susan Potter">
    <meta property="og:title" content="
  Dhall&#39;s =merge= keyword and union types - Susan Potter
">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/snippets/dhalls-merge-keyword-and-union-types/">
    <meta property="og:image" content="/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="/snippets/dhalls-merge-keyword-and-union-types/">
    <meta name="twitter:image" content="/">

    <title>
  Dhall&#39;s =merge= keyword and union types - Susan Potter
</title>

    <link rel="canonical" href="/snippets/dhalls-merge-keyword-and-union-types/">
    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    
    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="/css/normalize.min.css">
    <link rel="stylesheet" href="/css/style.min.css">

    

    
      <link rel="stylesheet" href="/styles/main.css">
    

    <link href="/favicon.ico" rel="shortcut icon">

    
      <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Susan Potter">
      <link href="/index.xml" rel="feed" type="application/rss+xml" title="Susan Potter" />
    

    <meta name="generator" content="Hugo 0.64.0" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">Susan Potter</a>
    <input type="checkbox" id="menu-control"/>
    <label class="menu-mobile  float-right " for="menu-control">
      <span class="btn-mobile  float-right ">&#9776;</span>
      <ul class="navigation-list">
        
          
            <li class="navigation-item   align-left  ">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
            <li class="navigation-item   align-left  ">
              <a class="navigation-link" href="/talks/">Talks</a>
            </li>
          
            <li class="navigation-item   align-left  ">
              <a class="navigation-link" href="/software/">Software</a>
            </li>
          
            <li class="navigation-item   align-left  ">
              <a class="navigation-link" href="/snippets/">Snippets</a>
            </li>
          
        
        
      </ul>
    </label>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Dhall&#39;s =merge= keyword and union types</h1>
      <div class="dateinfo">
        
        <span class="date"><strong>Date:</strong> September 21, 2020</span>
        
        
        <span class="lastmod"><strong>Last modified:</strong> September 21, 2020</span>
        
      
        <div class="draft">DRAFT</div>
      

      </div>

    </header>

    
<p>
At work my team uses Dhall to generate configuration for services or
environments and one thing we often need to do is define union types
(also known as sum types).
</p>
<h3 id="headline-1">
Pattern matching in Haskell/PureScript background
</h3>
<p>
In Haskell and PureScript, we can use a feature of the language called
pattern matching to be able to match a particular construction of a
sum type value.
</p>
<p>
For instance, let us start off with a simple special case of a sum
type, an enumeration type:
</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#66d9ef">data</span> <span style="color:#66d9ef">Shell</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Bash</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Zsh</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Fish</span></code></pre></div>
</div>
<p>
Suppose we are trying to decipher between the available options of
shells a developer might be using and producing the shebang for the
shell:
</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#a6e22e">shebang</span> <span style="color:#f92672">::</span> <span style="color:#66d9ef">Shell</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">String</span>
<span style="color:#a6e22e">shebang</span> <span style="color:#66d9ef">Bash</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#!/bin/bash</span><span style="color:#e6db74">&#34;</span>
<span style="color:#a6e22e">shebang</span> <span style="color:#66d9ef">Zsh</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#!/bin/zsh</span><span style="color:#e6db74">&#34;</span>
<span style="color:#a6e22e">shebang</span> <span style="color:#66d9ef">Fish</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#!/bin/fish</span><span style="color:#e6db74">&#34;</span></code></pre></div>
</div>
<p>
Because we can only ever construct a value of type <code class="verbatim">Shell</code> with one of
the three data constructors (<code class="verbatim">Bash</code>, <code class="verbatim">Zsh</code>, <code class="verbatim">Fish</code>) none of which take
arguments, then by looking at the <code class="verbatim">shebang</code> definition above we can
see we have handled all possible inputs and always produce a value
giving us totality in this simple case. The Haskell compiler I use
(GHC) also agrees and can check this for us.
</p>
<h3 id="headline-2">
Simulating pattern matching in Dhall (simple case)
</h3>
<p>
To provide the same functionality in Dhall we can do the following:
</p>
<div class="src src-dhall">
<pre><code class="language-dhall" data-lang="dhall">let Shell : Type = < Bash | Zsh | Fish >
let shebang = \(shell : Shell) ->
      merge { Bash = "#!/bin/bash"
            , Zsh  = "#!/bin/zsh"
            , Fish = "#!/bin/fish" }
            shell
in shebang Shell.Zsh</code></pre>
</div>
<p>
Above we can see we defined our <em>union type</em> (another name for a sum
type) on the first line like so:
</p>
<div class="src src-dhall">
<pre><code class="language-dhall" data-lang="dhall">let Shell : Type = < Bash | Zsh | Fish ></code></pre>
</div>
<p>
Next we define the function <code class="verbatim">shebang</code> by using the <code class="verbatim">merge</code> keyword. It
takes a record containing the data constructors as keys and a value.
</p>
<p>
In this case, our union type contains no arguments for any of the data
constructors. So our value is just the value we want returned upon a
<em>match</em>.
</p>
<h3 id="headline-3">
Matching more interesting union types in Dhall
</h3>
<p>
Let us suppose we now want to model different environments and their
<em>levels</em>, e.g. dev, qa, prod.
</p>
<p>
Going back to Haskell we can model each environment having a <em>level</em>
and possibly a <em>tag</em> like the following as a sum type:
</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#66d9ef">newtype</span> <span style="color:#66d9ef">Tag</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">MkTag</span> <span style="color:#66d9ef">Text</span>
<span style="color:#66d9ef">data</span> <span style="color:#66d9ef">Environment</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Prod</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">QA</span> <span style="color:#66d9ef">Tag</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Dev</span> <span style="color:#66d9ef">Tag</span></code></pre></div>
</div>
<p>
In our case, we might not need a <em>tag</em> for <code class="verbatim">Prod</code> because there is
only one production environment, but we dynamically create <code class="verbatim">QA</code>
environments per story and each developer locally develops in their
own development environment. We do this because logs, metrics, and
stack traces are reported from these environments we need to be able
to filter on the <em>tag</em> for these environments.
</p>
<p>
Examples values of <code class="verbatim">Environment</code> might be:
</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#75715e">-- &gt;&gt;&gt; Prod</span>

<span style="color:#75715e">-- &gt;&gt;&gt; QA &#34;CLUB-12345&#34;</span>

<span style="color:#75715e">-- &gt;&gt;&gt; Dev &#34;mbbx6spp@nixos0&#34;</span></code></pre></div>
</div>
<p>
Now to pattern match on this Haskell allows us to do the following:
</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#a6e22e">logServer</span> <span style="color:#f92672">::</span> <span style="color:#66d9ef">Environment</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">Hostname</span>
<span style="color:#a6e22e">logServer</span> <span style="color:#66d9ef">Prod</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logs.prod.example.com</span><span style="color:#e6db74">&#34;</span>
<span style="color:#a6e22e">logServer</span> (<span style="color:#66d9ef">QA</span> <span style="color:#66d9ef">_</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logs.qa.example.com</span><span style="color:#e6db74">&#34;</span>
<span style="color:#a6e22e">logServer</span> (<span style="color:#66d9ef">Dev</span> tag) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logs.</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;&gt;</span> username <span style="color:#f92672">&lt;&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.local</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">where</span> username <span style="color:#f92672">=</span> takeWhile (<span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;@&#39;</span>) tag</code></pre></div>
</div>

  </article>

  
</section>


      </div>
      
        <footer class="footer">
  <section class="container">
    
      <div class="sns-shares sp-sns-shares">
        
          <a class="sns-share twitter-share" aria-label="Share on twitter" href="https://twitter.com/intent/tweet?original_referer=%2fsnippets%2fdhalls-merge-keyword-and-union-types%2f&ref_src=twsrc%5Etfw&text=Dhall%27s%20%3dmerge%3d%20keyword%20and%20union%20types Susan%20Potter&tw_p=tweetbutton&url=%2fsnippets%2fdhalls-merge-keyword-and-union-types%2f"><i class="fab fa-twitter"></i></a>
        
        
          <a class="sns-share linkedIn-share" aria-label="Share on LinkedIn" href="https://www.linkedin.com/sharing/share-offsite/?url=%2fsnippets%2fdhalls-merge-keyword-and-union-types%2f"><i class="fab fa-linkedin"></i></a>
        
      </div>
    
    
  </section>
  <div class="fixed-bar">
    <section class="container">
      
      <div class="social-list">
        <span>Profiles:</span>
        
          <span class="social-item">
            <a href="https://github.com/mbbx6spp/" aria-label="Github" >
              
                <i class="fab fa-github" aria-hidden="true"></i>
              
            </a>
          </span>
        
          <span class="social-item">
            <a href="https://keybase.io/mbbx6spp" aria-label="Keybase" >
              
                <i class="fab fa-keybase" aria-hidden="true"></i>
              
            </a>
          </span>
        
          <span class="social-item">
            <a href="https://www.linkedin.com/in/susanpotter/" aria-label="LinkedIn" >
              
                <i class="fab fa-linkedin" aria-hidden="true"></i>
              
            </a>
          </span>
        
          <span class="social-item">
            <a href="https://slideshare.net/mbbx6spp" aria-label="Slideshare" >
              
                <i class="fab fa-slideshare" aria-hidden="true"></i>
              
            </a>
          </span>
        
          <span class="social-item">
            <a href="https://twitter.com/SusanPotter" aria-label="Twitter" >
              
                <i class="fab fa-twitter" aria-hidden="true"></i>
              
            </a>
          </span>
        
      </div>
      
      
        <div class="sns-shares pc-sns-shares">
          <span>Share:</span>
          
            <a class="sns-share twitter-share" aria-label="Share on twitter" href="https://twitter.com/intent/tweet?original_referer=%2fsnippets%2fdhalls-merge-keyword-and-union-types%2f&ref_src=twsrc%5Etfw&text=Dhall%27s%20%3dmerge%3d%20keyword%20and%20union%20types Susan%20Potter&tw_p=tweetbutton&url=%2fsnippets%2fdhalls-merge-keyword-and-union-types%2f"><i class="fab fa-twitter" aria-hidden="true"></i></a>
          
          
            <a class="sns-share linkedIn-share" aria-label="Share on LinkedIn" href="https://www.linkedin.com/sharing/share-offsite/?url=%2fsnippets%2fdhalls-merge-keyword-and-union-types%2f"><i class="fab fa-linkedin" aria-hidden="true"></i></a>
          
        </div>
      
    </section>
  </div>
</footer>

      
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-837842-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  <script src="/js/app.js"></script>
  
  </body>
</html>
