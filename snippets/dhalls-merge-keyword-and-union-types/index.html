<!DOCTYPE html>
<html><meta charset="UTF-8">
<meta name="template-type" content="snippets">
<meta name="template-kind" content="page">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">




  <link rel="stylesheet" href="/css/suponet.css" integrity="">


<meta name="author" content="Susan Potter">
<meta name="description" content="">
<meta name="keywords" content="[]">
<meta name="theme-color" content="">
<meta name="og:site_name" content="Susan Potter"/>
<meta name="og:title" content='Dhall&#39;s =merge= keyword and union types &ndash; Susan Potter'/>
<meta name="og:url" content="/snippets/dhalls-merge-keyword-and-union-types/">
<meta name="og:description" content="">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="SusanPotter">
<meta name="twitter:creator" content="SusanPotter">

<meta name="twitter:image" content="/images/hat-collage.jpg">


<meta name="twitter:image:alt" content="Susan&#39;s avatar wearing many different hats.">

<meta name="twitter:title" content='Dhall&#39;s =merge= keyword and union types &ndash; Susan Potter'>
<meta name="twitter:description" content="">
<title>Dhall&#39;s =merge= keyword and union types &ndash; Susan Potter</title>

<meta property="og:type" content="website" />
<body class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-900"><header class="text-gray-600 body-font">
  <div class="container mx-auto flex flex-wrap py-6 px-12 flex-col md:flex-row items-center">
    <a href="/" class="flex title-font font-medium items-center text-gray-700 dark:text-gray-200 mb-4 md:mb-0">
      <h1 class="ml-3 text-2xl font-bold">Susan Potter</h1>
    </a>
    
    <nav class="md:ml-auto flex flex-wrap items-center text-base justify-center">
      
      <a href="/about/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">About</a>
      
      <a href="/talks/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">Talks</a>
      
      <a href="/software/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">Software</a>
      
      <a href="/snippets/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">Snippets</a>
      
    </nav>
    
  </div>

  
  <hgroup class="text-black dark:text-gray-50 container mx-auto px-16 pb-3">
    <h2 class="text-3xl font-extrabold tracking-wider leading-loose">Dhall&#39;s =merge= keyword and union types</h2>
    
    <h3 class="text-gray-800 dark:text-gray-200">Mon September 9, 2020</h3>
    <h4 class="uppercase text-gray-600 dark:text-gray-200 font-bold">DRAFT</h4>
    
  </hgroup>
  
</header>

<main class="container px-16 mx-auto rounded-md border shadow border-gray-400 dark:border-gray-600 py-2">
  
<p>
At work my team uses Dhall to generate configuration for services or
environments and one thing we often need to do is define union types
(also known as sum types).</p>
<div id="outline-container-headline-1" class="outline-3">
<h3 id="headline-1">
Pattern matching in Haskell/PureScript background
</h3>
<div id="outline-text-headline-1" class="outline-text-3">
<p>
In Haskell and PureScript, we can use a feature of the language called
pattern matching to be able to match a particular construction of a
sum type value.</p>
<p>
For instance, let us start off with a simple special case of a sum
type, an enumeration type:</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#66d9ef">data</span> <span style="color:#66d9ef">Shell</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Bash</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Zsh</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Fish</span></code></pre></div>
</div>
<p>
Suppose we are trying to decipher between the available options of
shells a developer might be using and producing the shebang for the
shell:</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#a6e22e">shebang</span> <span style="color:#f92672">::</span> <span style="color:#66d9ef">Shell</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">String</span>
<span style="color:#a6e22e">shebang</span> <span style="color:#66d9ef">Bash</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#!/bin/bash&#34;</span>
<span style="color:#a6e22e">shebang</span> <span style="color:#66d9ef">Zsh</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#!/bin/zsh&#34;</span>
<span style="color:#a6e22e">shebang</span> <span style="color:#66d9ef">Fish</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#!/bin/fish&#34;</span></code></pre></div>
</div>
<p>
Because we can only ever construct a value of type <code class="verbatim">Shell</code> with one of
the three data constructors (<code class="verbatim">Bash</code>, <code class="verbatim">Zsh</code>, <code class="verbatim">Fish</code>) none of which take
arguments, then by looking at the <code class="verbatim">shebang</code> definition above we can
see we have handled all possible inputs and always produce a value
giving us totality in this simple case. The Haskell compiler I use
(GHC) also agrees and can check this for us.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
Simulating pattern matching in Dhall (simple case)
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<p>
To provide the same functionality in Dhall we can do the following:</p>
<div class="src src-dhall">
<pre><code class="language-dhall" data-lang="dhall">let Shell : Type = &lt; Bash | Zsh | Fish &gt;
let shebang = \(shell : Shell) -&gt;
      merge { Bash = &#34;#!/bin/bash&#34;
            , Zsh  = &#34;#!/bin/zsh&#34;
            , Fish = &#34;#!/bin/fish&#34; }
            shell
in shebang Shell.Zsh</code></pre>
</div>
<p>
Above we can see we defined our <em>union type</em> (another name for a sum
type) on the first line like so:</p>
<div class="src src-dhall">
<pre><code class="language-dhall" data-lang="dhall">let Shell : Type = &lt; Bash | Zsh | Fish &gt;</code></pre>
</div>
<p>
Next we define the function <code class="verbatim">shebang</code> by using the <code class="verbatim">merge</code> keyword. It
takes a record containing the data constructors as keys and a value.</p>
<p>
In this case, our union type contains no arguments for any of the data
constructors. So our value is just the value we want returned upon a
<em>match</em>.</p>
</div>
</div>
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
Matching more interesting union types in Dhall
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<p>
Let us suppose we now want to model different environments and their
<em>levels</em>, e.g. dev, qa, prod.</p>
<p>
Going back to Haskell we can model each environment having a <em>level</em>
and possibly a <em>tag</em> like the following as a sum type:</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#66d9ef">newtype</span> <span style="color:#66d9ef">Tag</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">MkTag</span> <span style="color:#66d9ef">Text</span>
<span style="color:#66d9ef">data</span> <span style="color:#66d9ef">Environment</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Prod</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">QA</span> <span style="color:#66d9ef">Tag</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Dev</span> <span style="color:#66d9ef">Tag</span></code></pre></div>
</div>
<p>
In our case, we might not need a <em>tag</em> for <code class="verbatim">Prod</code> because there is
only one production environment, but we dynamically create <code class="verbatim">QA</code>
environments per story and each developer locally develops in their
own development environment. We do this because logs, metrics, and
stack traces are reported from these environments we need to be able
to filter on the <em>tag</em> for these environments.</p>
<p>
Examples values of <code class="verbatim">Environment</code> might be:</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#75715e">-- &gt;&gt;&gt; Prod</span>

<span style="color:#75715e">-- &gt;&gt;&gt; QA &#34;CLUB-12345&#34;</span>

<span style="color:#75715e">-- &gt;&gt;&gt; Dev &#34;mbbx6spp@nixos0&#34;</span></code></pre></div>
</div>
<p>
Now to pattern match on this Haskell allows us to do the following:</p>
<div class="src src-haskell">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-haskell" data-lang="haskell"><span style="color:#a6e22e">logServer</span> <span style="color:#f92672">::</span> <span style="color:#66d9ef">Environment</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">Hostname</span>
<span style="color:#a6e22e">logServer</span> <span style="color:#66d9ef">Prod</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;logs.prod.example.com&#34;</span>
<span style="color:#a6e22e">logServer</span> (<span style="color:#66d9ef">QA</span> <span style="color:#66d9ef">_</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;logs.qa.example.com&#34;</span>
<span style="color:#a6e22e">logServer</span> (<span style="color:#66d9ef">Dev</span> tag) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;logs.&#34;</span> <span style="color:#f92672">&lt;&gt;</span> username <span style="color:#f92672">&lt;&gt;</span> <span style="color:#e6db74">&#34;.local&#34;</span>
  <span style="color:#66d9ef">where</span> username <span style="color:#f92672">=</span> takeWhile (<span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;@&#39;</span>) tag</code></pre></div>
</div>
</div>
</div>

</main>
<footer class="h-full text-gray-600 dark:text-gray-200 body-font w-full mt-8 md:mt-12 lg:mt-16 xl:mt-20">
  <div class="bg-blue-50 dark:bg-gray-800 text-gray-600 dark:text-gray-200 p-2">
    <div class="container mx-auto py-4 px-16 flex flex-wrap flex-col sm:flex-row">
      <p class="text-sm text-center sm:text-left">© 2006 - 2021 Susan Potter —
        <a href="https://twitter.com/SusanPotter" rel="noopener noreferrer" class="ml-1" target="_blank">@SusanPotter</a>
      </p>
      
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-2 justify-center sm:justify-start">
        
        <a href="https://github.com/mbbx6spp/" class="ml-3" title="mbbx6spp on Github" aria-label="Susan is mbbx6spp on Github" >
          <img src="/images/github.svg" width=24 height=24 alt="Github icon"/>
        </a>
        
        <a href="https://keybase.io/mbbx6spp" class="ml-3" title="mbbx6spp on Keybase" aria-label="Susan is mbbx6spp on Keybase" >
          <img src="/images/keybase.svg" width=24 height=24 alt="Keybase icon"/>
        </a>
        
        <a href="https://www.linkedin.com/in/susanpotter/" class="ml-3" title="susanpotter on LinkedIn" aria-label="Susan is susanpotter on LinkedIn" >
          <img src="/images/linkedin.svg" width=24 height=24 alt="LinkedIn icon"/>
        </a>
        
        <a href="https://slideshare.net/mbbx6spp" class="ml-3" title="mbbx6spp on Slideshare" aria-label="Susan is mbbx6spp on Slideshare" >
          <img src="/images/slideshare.svg" width=24 height=24 alt="Slideshare icon"/>
        </a>
        
        <a href="https://twitter.com/SusanPotter" class="ml-3" title="SusanPotter on Twitter" aria-label="Susan is SusanPotter on Twitter" >
          <img src="/images/twitter.svg" width=24 height=24 alt="Twitter icon"/>
        </a>
        
      </span>
      
    </div>
  </div>
</footer>
</body>
</html>
