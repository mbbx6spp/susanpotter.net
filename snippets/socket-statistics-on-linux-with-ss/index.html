<!DOCTYPE html>
<html lang="en-us"><meta charset="UTF-8">
<meta name="template-type" content="snippets">
<meta name="template-kind" content="page">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">




  <link rel="stylesheet" href="/css/suponet.css" integrity="">


<meta name="author" content="Susan Potter">
<meta name="description" content="Learn how to troubleshoot sockets using the ss command on Linux">
<meta name="keywords" content="[]">
<meta name="theme-color" content="">
<meta name="og:site_name" content="Susan Potter"/>
<meta name="og:title" content='Socket Statistics on Linux with ss &ndash; Susan Potter'/>
<meta name="og:url" content="/snippets/socket-statistics-on-linux-with-ss/">
<meta name="og:description" content="Learn how to troubleshoot sockets using the ss command on Linux">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="SusanPotter">
<meta name="twitter:creator" content="SusanPotter">

<meta name="twitter:image" content="/images/hat-collage.jpg">


<meta name="twitter:image:alt" content="Susan&#39;s avatar wearing many different hats.">

<meta name="twitter:title" content='Socket Statistics on Linux with ss &ndash; Susan Potter'>
<meta name="twitter:description" content="Learn how to troubleshoot sockets using the ss command on Linux">
<title>Socket Statistics on Linux with ss &ndash; Susan Potter</title>

<meta property="og:type" content="website" />
<body class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-900"><header class="text-gray-600 body-font">
  <div class="container mx-auto flex flex-wrap py-6 px-12 flex-col md:flex-row items-center">
    <a href="/" class="flex title-font font-medium items-center text-gray-700 dark:text-gray-200 mb-4 md:mb-0">
      <h1 class="ml-3 text-2xl font-bold">Susan Potter</h1>
    </a>
    
    <nav class="md:ml-auto flex flex-wrap items-center text-base justify-center">
      
      <a href="/about/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">About</a>
      
      <a href="/talks/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">Talks</a>
      
      <a href="/software/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">Software</a>
      
      <a href="/snippets/" class="mx-6 text-xl text-pink-600 hover:underline dark:text-pink-500">Snippets</a>
      
    </nav>
    
  </div>

  
  <hgroup class="text-black dark:text-gray-50 container mx-auto px-16 pb-3">
    <h2 class="text-3xl font-extrabold tracking-wider leading-loose">Socket Statistics on Linux with ss</h2>
    
    <h3 class="text-gray-800 dark:text-gray-200">Wed April 4, 2019</h3>
    
    
  </hgroup>
  
</header>

<main class="container px-16 mx-auto rounded-md border shadow-md border-gray-200 dark:border-gray-600 py-2">
  <p>An excellent tool when you need to troubleshoot distributed systems is <code>ss</code>, which provides visibility into TCP states of your live connections. Even if you know <code>netstat</code> this is a command you should get acquainted with because of its more powerful interface which requires fewer pipes to find the connection information you need and it is probably already installed on your favorite distribution.</p>
<p>In this post, we walk through a couple of examples, and then show a real-world production problem that can be diagnosed by effective use of <code>ss</code>.</p>
<p>To list TCP [<code>-t</code>] connections with destination port 9200 [<code>dst :9200</code>] and showing numeric port [<code>-n</code>] plus resolving DNS of addresses [<code>-r</code>] we use the following:</p>
<pre><code>ss -rnt dst :9200
</code></pre><p>The output of the above command might look something like this:</p>
<pre><code>Recv-Q Send-Q                         Local Address:Port                           Peer Address:Port
0      0                                  localhost:28655                             localhost:9200

# OR

Recv-Q Send-Q             Local Address:Port               Peer Address:Port
0      0         mysvc1-app3.dc1.exampleapp.com:44541      logs.dc1.exampleapp.com:9200
0      0         mysvc1-app3.dc1.exampleapp.com:33389      logs.dc1.exampleapp.com:9200
0      0         mysvc1-app3.dc1.exampleapp.com:45740      logs.dc1.exampleapp.com:9200
0      0         mysvc1-app3.dc1.exampleapp.com:53848      logs.dc1.exampleapp.com:9200
0      0         mysvc1-app3.dc1.exampleapp.com:33406      logs.dc1.exampleapp.com:9200
0      0         mysvc1-app3.dc1.exampleapp.com:33407      logs.dc1.exampleapp.com:9200
0      0         mysvc1-app3.dc1.exampleapp.com:33405      logs.dc1.exampleapp.com:9200
</code></pre><p>Now, this isn&rsquo;t very remarkable. Let&rsquo;s try to find TCP connections in <code>CLOSE_WAIT</code> state going to a specific destination address and port:</p>
<pre><code>$ /usr/sbin/ss -tarn state close-wait

Recv-Q Send-Q                              Local Address:Port                                Peer Address:Port
1      0         mysvc-app1.dc1.exampleapp.com:40701    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:29470    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:35594    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:39683    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:22715    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:23824    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:37015   mysvc-app10.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:28927    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:37298    mysvc-app1.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:42596   mysvc-app20.dc1.exampleapp.com:50010
1      0         mysvc-app1.dc1.exampleapp.com:45345    mysvc-app1.dc1.exampleapp.com:50010
</code></pre><p>What about timers on sockets? Well, <code>ss</code> has what you want (list all [<code>-a</code>] TCP sockets [<code>-t</code>] with resoled DNS [<code>-r</code>], numeric ports [<code>-n</code>] that are in state of <code>TIME_WAIT</code> with timer information [<code>-o</code>]):</p>
<pre><code>$ ss -arnto state time-wait

Recv-Q Send-Q                              Local Address:Port                                Peer Address:Port
0      0         mysvc-app1.dc1.exampleapp.com:21665                   ldap.dc1.exampleapp.com:389    timer:(timewait,22sec,0)
0      0         mysvc-app1.dc1.exampleapp.com:45311   mysvc-app13.dc1.exampleapp.com:2191   timer:(timewait,24sec,0)
0      0         mysvc-app1.dc1.exampleapp.com:21606                   ldap.dc1.exampleapp.com:389    timer:(timewait,2.730ms,0)
0      0         mysvc-app1.dc1.exampleapp.com:40319    mysvc-app2.dc1.exampleapp.com:9092   timer:(timewait,4.949ms,0)
0      0         mysvc-app1.dc1.exampleapp.com:37364   mysvc-app12.dc1.exampleapp.com:2191   timer:(timewait,28sec,0)
0      0                                       localhost:39282                                  localhost:17123  timer:(timewait,54sec,0)

</code></pre><h2 id="look-ma-no-pipes">Look ma, no pipes!</h2>
<p>Looking for which process is listening on a port? Simple:</p>
<ul>
<li>using <code>-l</code> we limit ourselves to listening sockets</li>
<li>using <code>-t</code> we limit ourselves to TCP</li>
<li>using <code>-n</code> we make sure the port is shown as numeric not alias</li>
<li>using <code>-r</code> we resolve the hostnames</li>
<li>using <code>-p</code> we show processes using that socket</li>
</ul>
<p>Remember to get process information you usually need to sudo :)</p>
<pre><code>$ sudo ss -nltp state listening src :3030
Recv-Q Send-Q                                                           Local Address:Port                                                             Peer Address:Port
0      100                                                                  127.0.0.1:3030                                                                        *:*      users:((&quot;sensu-client&quot;,46889,17))
</code></pre><p>Note the users output is a 3-tuple with the process name as first entry, the PID as the second entry and <em>unknown</em> third entry (to me). Anyone know, it isn&rsquo;t explained in the man page.</p>
<h2 id="can-anybody-hear-me">Can Anybody Hear Me?</h2>
<p>Finally, let us walk through a production issue where <code>ss</code> helped us get to the root of the issue faster. Recently an alert was generated when one of our services in an environnt was no longer receiving Kafka messages. After taking the necessary steps to ensure that the Kafka cluster was up and functioning correctly, we went to the node that alerted. There we used <code>ss</code> to check for TCP connections to Kafka we saw no established TCP connections to Kafka, but we did see a connection in TCP state <code>'syn-sent'</code>[1]:</p>
<pre><code>$ sudo ss -antlp state syn-sent dst :9200
Recv-Q                        Send-Q                                               Local Address:Port                                                 Peer Address:Port
0                             1                                                        10.4.1.40:48928                                                   10.4.1.80:9200                         users:((&quot;java&quot;,pid=13657,fd=3))
</code></pre><p>The output above tells us some useful information, specifically that this host is trying to talk to Kafka, but it isn&rsquo;t able to connect to the broker. This information allowed us to investigate a possible networking problem, and in this specific example the DNS for Kafka had changed, and the application had cached the old entry.</p>
<p>1: <a href="https://en.wikipedia.org/wiki/TCP_half-open#Embryonic_connection">https://en.wikipedia.org/wiki/TCP_half-open#Embryonic_connection</a></p>

</main>
<footer class="h-full text-gray-600 dark:text-gray-200 body-font w-full mt-8 md:mt-12 lg:mt-16 xl:mt-20">
  <div class="bg-blue-50 dark:bg-gray-800 text-gray-600 dark:text-gray-200 p-2">
    <div class="container mx-auto py-4 px-16 flex flex-wrap flex-col sm:flex-row">
      <p class="text-sm text-center sm:text-left">© 2006 - 2021 Susan Potter —
        <a href="https://twitter.com/SusanPotter" rel="noopener noreferrer" class="ml-1" target="_blank" aria-hidden="true">@SusanPotter</a>
      </p>
      
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-2 justify-center sm:justify-start">
        
        <a href="https://github.com/mbbx6spp/" class="ml-3" title="mbbx6spp on Github" aria-label="Susan is mbbx6spp on Github" >
          <img src="/images/github.svg" width=24 height=24 alt="Github icon"/>
        </a>
        
        <a href="https://keybase.io/mbbx6spp" class="ml-3" title="mbbx6spp on Keybase" aria-label="Susan is mbbx6spp on Keybase" >
          <img src="/images/keybase.svg" width=24 height=24 alt="Keybase icon"/>
        </a>
        
        <a href="https://www.linkedin.com/in/susanpotter/" class="ml-3" title="susanpotter on LinkedIn" aria-label="Susan is susanpotter on LinkedIn" >
          <img src="/images/linkedin.svg" width=24 height=24 alt="LinkedIn icon"/>
        </a>
        
        <a href="https://slideshare.net/mbbx6spp" class="ml-3" title="mbbx6spp on Slideshare" aria-label="Susan is mbbx6spp on Slideshare" >
          <img src="/images/slideshare.svg" width=24 height=24 alt="Slideshare icon"/>
        </a>
        
        <a href="https://twitter.com/SusanPotter" class="ml-3" title="SusanPotter on Twitter" aria-label="Susan is SusanPotter on Twitter" >
          <img src="/images/twitter.svg" width=24 height=24 alt="Twitter icon"/>
        </a>
        
      </span>
      
    </div>
  </div>
</footer>
</body>
</html>
